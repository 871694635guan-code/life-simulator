<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIäººç”Ÿæ¨¡æ‹Ÿå™¨ - ç²¾ç¡®æš‚åœç‰ˆ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        @media (max-width: 900px) {
            .main-layout { grid-template-columns: 1fr; }
        }
        
        .section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid transparent;
            transition: border-color 0.3s;
        }
        .section.paused {
            border-color: #f39c12;
            background: #fffbeb;
        }
        .section h3 {
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: bold;
            font-size: 14px;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        input:disabled {
            background: #e0e0e0;
            cursor: not-allowed;
        }
        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .target-list {
            max-height: 250px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .target-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .target-item.completed {
            border-left-color: #27ae60;
            background: #f0fff4;
        }
        .target-info h4 {
            color: #333;
            margin-bottom: 5px;
            font-size: 14px;
        }
        .target-info p {
            color: #666;
            font-size: 12px;
        }
        .target-status {
            font-size: 20px;
        }
        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 5px;
        }
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        .btn-add {
            background: #27ae60;
            color: white;
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
        }
        .btn-add:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            padding: 20px;
            background: #f0f0f0;
            border-radius: 15px;
            align-items: center;
        }
        .btn {
            flex: 1;
            min-width: 100px;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        .btn-success {
            background: #27ae60;
            color: white;
        }
        .btn-danger2 {
            background: #e74c3c;
            color: white;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 2;
            min-width: 200px;
        }
        .speed-control label {
            margin: 0;
            white-space: nowrap;
        }
        .speed-control input {
            flex: 1;
        }
        .speed-value {
            min-width: 60px;
            text-align: center;
            font-weight: bold;
            color: #667eea;
        }
        
        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        .status-badge.running {
            background: #d5f4e6;
            color: #27ae60;
        }
        .status-badge.paused {
            background: #fef5e7;
            color: #f39c12;
        }
        .status-badge.stopped {
            background: #fadbd8;
            color: #e74c3c;
        }
        
        .simulation-area {
            display: none;
            margin-top: 30px;
        }
        .simulation-area.active {
            display: block;
        }
        
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-card h4 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }
        .stat-compare {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
            font-size: 14px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-item.work { color: #3498db; }
        .stat-item.gamble { color: #e74c3c; }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
            display: flex;
        }
        .progress-segment {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            transition: width 0.3s;
        }
        .progress-work { background: #3498db; }
        .progress-gamble { background: #e74c3c; }
        
        .status-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            text-align: center;
        }
        .status-item h4 {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        .status-item p {
            font-size: 18px;
            font-weight: bold;
        }
        .pressure-detail {
            font-size: 11px;
            opacity: 0.8;
            margin-top: 5px;
            word-break: break-all;
        }
        
        .daily-log {
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .log-entry {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            background: white;
            border-left: 4px solid #ddd;
            animation: slideIn 0.3s;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .log-entry.gamble-win { border-left-color: #27ae60; background: #f0fff4; }
        .log-entry.gamble-loss { border-left-color: #e74c3c; background: #fdf2f2; }
        .log-entry.work { border-left-color: #3498db; background: #eff6ff; }
        .log-entry.paused-marker { 
            border-left-color: #f39c12; 
            background: #fef5e7;
            text-align: center;
            font-weight: bold;
        }
        
        .log-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .log-action {
            font-weight: bold;
        }
        .log-pressure {
            font-size: 20px;
        }
        .log-body {
            color: #666;
            font-size: 12px;
            line-height: 1.6;
        }
        .log-reason {
            color: #667eea;
            font-style: italic;
            margin-top: 5px;
            padding: 5px;
            background: #f0f0f0;
            border-radius: 5px;
        }
        
        .year-marker {
            background: #667eea;
            color: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin: 15px 0;
            font-weight: bold;
        }
        .target-completed-notice {
            background: #f39c12;
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
            animation: pulse 1s;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        .final-result {
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            margin-top: 20px;
        }
        .final-result.success { background: #d5f4e6; color: #27ae60; }
        .final-result.fail { background: #fadbd8; color: #e74c3c; }
        
        .paused-notice {
            background: #f39c12;
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .locked-field {
            background: #fff3cd !important;
            border-color: #ffc107 !important;
        }
        .locked-hint {
            font-size: 12px;
            color: #856404;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ® AIäººç”Ÿæ¨¡æ‹Ÿå™¨</h1>
        <p class="subtitle">ç²¾ç¡®æš‚åœç‰ˆ - å®Œæˆå½“å¤©ååœæ­¢</p>
        
        <div class="main-layout">
            <!-- å·¦ä¾§ï¼šåŸºç¡€è®¾å®š -->
            <div class="section" id="configSection">
                <h3>
                    âš™ï¸ åŸºç¡€è®¾å®š
                    <span class="status-badge stopped" id="configStatus">æœªå¼€å§‹</span>
                </h3>
                <div class="row">
                    <div class="form-group">
                        <label>åˆå§‹å¹´é¾„ ğŸ”’</label>
                        <input type="number" id="startAge" value="18" min="1" class="locked-field">
                        <div class="locked-hint">æ¨¡æ‹Ÿå¼€å§‹åä¸å¯ä¿®æ”¹</div>
                    </div>
                    <div class="form-group">
                        <label>æœ€å¤§å¹´é¾„ï¼ˆæ—¶é™ï¼‰</label>
                        <input type="number" id="deadlineAge" value="60" min="1">
                    </div>
                </div>
                <div class="row">
                    <div class="form-group">
                        <label>æ¯æ—¥ç”Ÿæ´»æˆæœ¬ï¼ˆå…ƒï¼‰</label>
                        <input type="number" id="dailyCost" value="50" min="0">
                    </div>
                    <div class="form-group">
                        <label>æ‰“å·¥æ—¥æ”¶å…¥ï¼ˆå…ƒï¼‰</label>
                        <input type="number" id="workIncome" value="200" min="1">
                    </div>
                </div>
                <div class="row">
                    <div class="form-group">
                        <label>èµŒåšèƒœç‡ï¼ˆ%ï¼‰</label>
                        <input type="number" id="gambleWinRate" value="70" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label>èµŒåšèµ¢èµšï¼ˆå…ƒï¼‰</label>
                        <input type="number" id="gambleWinAmount" value="800" min="1">
                    </div>
                </div>
                <div class="form-group">
                    <label>èµŒåšè¾“èµ”ï¼ˆå…ƒï¼‰</label>
                    <input type="number" id="gambleLossAmount" value="1000" min="1">
                </div>
            </div>
            
            <!-- å³ä¾§ï¼šç›®æ ‡ç®¡ç† -->
            <div class="section" id="targetSection">
                <h3>
                    ğŸ¯ ç›®æ ‡åˆ—è¡¨ï¼ˆç´¯è®¡åˆ¶ï¼‰
                    <span style="font-size:12px; color:#666; font-weight:normal;">ç›®æ ‡é‡‘é¢ä¼šå åŠ </span>
                </h3>
                <div class="target-list" id="targetList"></div>
                
                <div style="margin-top:15px; padding:15px; background:white; border-radius:10px;">
                    <h4 style="margin-bottom:10px; color:#667eea;">â• æ–°å¢ç›®æ ‡</h4>
                    <div class="form-group">
                        <label>ç›®æ ‡æè¿°</label>
                        <input type="text" id="newTargetDesc" placeholder="ä¾‹å¦‚ï¼šä¹°ç¬¬ä¸€å¥—æˆ¿">
                    </div>
                    <div class="row">
                        <div class="form-group">
                            <label>ç›®æ ‡é‡‘é¢ï¼ˆå…ƒï¼‰</label>
                            <input type="number" id="newTargetAmount" placeholder="500000" min="1">
                        </div>
                        <div class="form-group">
                            <label>è¾¾æˆæ—¶é™ï¼ˆå²å‰ï¼‰</label>
                            <input type="number" id="newTargetDeadline" placeholder="30" min="1">
                        </div>
                    </div>
                    <button class="btn-add" id="btnAddTarget" onclick="addTarget()">æ·»åŠ ç›®æ ‡</button>
                </div>
            </div>
        </div>
        
        <!-- æ§åˆ¶åŒº -->
        <div class="controls">
            <button class="btn btn-primary" id="btnStart" onclick="startSimulation()">ğŸš€ å¼€å§‹æ¨¡æ‹Ÿ</button>
            <button class="btn btn-warning" id="btnPause" onclick="requestPause()" disabled>â¸ï¸ æš‚åœä¿®æ”¹</button>
            <button class="btn btn-success" id="btnResume" onclick="resumeSimulation()" disabled>â–¶ï¸ ç»§ç»­</button>
            <button class="btn btn-danger2" id="btnReset" onclick="resetSimulation()">ğŸ”„ é‡æ–°æ¨¡æ‹Ÿ</button>
            
            <div class="speed-control">
                <label>âš¡ é€Ÿåº¦ï¼š</label>
                <input type="range" id="speedRange" min="50" max="3000" value="800" step="50">
                <span class="speed-value" id="speedValue">0.8ç§’</span>
            </div>
        </div>
        
        <!-- æš‚åœæç¤º -->
        <div class="paused-notice" id="pausedNotice" style="display:none;">
            â¸ï¸ æ¨¡æ‹Ÿå·²æš‚åœï¼ç¬¬ <span id="pausedDay">0</span> å¤©å·²å®Œæˆï¼Œä½ å¯ä»¥ä¿®æ”¹é™¤"åˆå§‹å¹´é¾„"å¤–çš„æ‰€æœ‰è®¾å®šï¼Œç„¶åç‚¹å‡»"ç»§ç»­"å¼€å§‹ç¬¬ <span id="nextDay">0</span> å¤©
        </div>
        
        <!-- æ¨¡æ‹Ÿæ˜¾ç¤ºåŒº -->
        <div class="simulation-area" id="simArea">
            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="stats-bar">
                <div class="stat-card">
                    <h4>ğŸ“Š å†³ç­–ç»Ÿè®¡</h4>
                    <div class="stat-compare">
                        <div class="stat-item work">
                            <div style="font-size:24px;">ğŸ’¼</div>
                            <div id="stat-work">0å¤©</div>
                        </div>
                        <div style="color:#999;">VS</div>
                        <div class="stat-item gamble">
                            <div style="font-size:24px;">ğŸ°</div>
                            <div id="stat-gamble">0å¤©</div>
                        </div>
                    </div>
                    <div class="progress-bar" style="margin-top:10px; height:20px;">
                        <div class="progress-segment progress-work" id="progress-work" style="width:50%">æ‰“å·¥ 50%</div>
                        <div class="progress-segment progress-gamble" id="progress-gamble" style="width:50%">èµŒåš 50%</div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <h4>ğŸ’° è´¢åŠ¡ç»Ÿè®¡</h4>
                    <div class="stat-value" id="stat-money">0</div>
                    <div style="color:#666; font-size:12px; margin-top:5px;">
                        æ€»æ”¶å…¥: <span id="stat-income">0</span> | 
                        æ€»æ”¯å‡º: <span id="stat-expense">0</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <h4>ğŸ² èµŒåšè®°å½•</h4>
                    <div class="stat-compare">
                        <div class="stat-item" style="color:#27ae60;">
                            <div style="font-size:20px;">ğŸ†</div>
                            <div id="stat-wins">0èƒœ</div>
                        </div>
                        <div class="stat-item" style="color:#e74c3c;">
                            <div style="font-size:20px;">ğŸ’”</div>
                            <div id="stat-losses">0è´Ÿ</div>
                        </div>
                    </div>
                    <div style="margin-top:10px; font-size:12px; color:#666;">
                        èƒœç‡: <span id="stat-winrate">0%</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <h4>ğŸ“… å·²æ¨¡æ‹Ÿå¤©æ•°</h4>
                    <div class="stat-value" id="stat-days">0</div>
                    <div style="color:#666; font-size:12px; margin-top:5px;">
                        å½“å‰å¹´é¾„: <span id="stat-age">18</span>å²
                    </div>
                </div>
            </div>
            
            <div class="status-bar">
                <div class="status-item">
                    <h4>å½“å‰å¹´é¾„</h4>
                    <p id="display-age">-</p>
                </div>
                <div class="status-item">
                    <h4>å­˜æ¬¾</h4>
                    <p id="display-money">-</p>
                </div>
                <div class="status-item">
                    <h4>ç´¯è®¡ç›®æ ‡</h4>
                    <p id="display-target">-</p>
                </div>
                <div class="status-item">
                    <h4>å‹åŠ›çŠ¶æ€</h4>
                    <p id="display-pressure">-</p>
                    <div class="pressure-detail" id="pressure-reason">-</div>
                </div>
                <div class="status-item">
                    <h4>å·²è¿›è¡Œ</h4>
                    <p id="display-day">-</p>
                </div>
            </div>
            
            <div class="daily-log" id="dailyLog"></div>
            <div id="finalResult"></div>
        </div>
    </div>

    <script>
        let targets = [];
        let isRunning = false;
        let isPaused = false;
        let isWaitingForResume = false;
        let simulationTimeout = null;
        let currentSpeed = 800;
        
        // åˆå§‹åŒ–ç¤ºä¾‹ç›®æ ‡
        addTarget('å¤§å­¦æ¯•ä¸šå­˜é’±', 50000, 22);
        addTarget('ä¹°ç¬¬ä¸€è¾†è½¦', 150000, 28);
        
        function addTarget(desc, amount, deadline) {
            const description = desc || document.getElementById('newTargetDesc').value;
            const amountVal = parseInt(amount || document.getElementById('newTargetAmount').value);
            const deadlineVal = parseInt(deadline || document.getElementById('newTargetDeadline').value);
            
            if (!description || !amountVal || !deadlineVal) {
                alert('è¯·å¡«å†™å®Œæ•´çš„ç›®æ ‡ä¿¡æ¯');
                return;
            }
            
            const startAge = parseInt(document.getElementById('startAge').value);
            if (deadlineVal <= startAge) {
                alert('ç›®æ ‡æ—¶é™å¿…é¡»å¤§äºåˆå§‹å¹´é¾„');
                return;
            }
            
            const target = {
                id: Date.now(),
                description,
                amount: amountVal,
                deadlineAge: deadlineVal,
                completed: false
            };
            
            targets.push(target);
            renderTargets();
            
            if (!desc) {
                document.getElementById('newTargetDesc').value = '';
                document.getElementById('newTargetAmount').value = '';
                document.getElementById('newTargetDeadline').value = '';
            }
        }
        
        function removeTarget(id) {
            if (isRunning && !isPaused) {
                alert('è¯·å…ˆæš‚åœæ¨¡æ‹Ÿå†åˆ é™¤ç›®æ ‡');
                return;
            }
            targets = targets.filter(t => t.id !== id);
            renderTargets();
        }
        
        function renderTargets() {
            const list = document.getElementById('targetList');
            if (targets.length === 0) {
                list.innerHTML = '<p style="color:#999; text-align:center; padding:20px;">æš‚æ— ç›®æ ‡ï¼Œè¯·æ·»åŠ </p>';
                return;
            }
            
            let accumulated = 0;
            const sorted = [...targets].sort((a, b) => a.deadlineAge - b.deadlineAge);
            
            list.innerHTML = sorted.map((t, index) => {
                accumulated += t.amount;
                return `
                    <div class="target-item ${t.completed ? 'completed' : ''}">
                        <div class="target-info">
                            <h4>${index + 1}. ${t.completed ? 'âœ… ' : ''}${t.description}</h4>
                            <p>
                                æœ¬ç›®æ ‡: ${t.amount.toLocaleString()}å…ƒ | 
                                ç´¯è®¡éœ€: ${accumulated.toLocaleString()}å…ƒ | 
                                æ—¶é™: ${t.deadlineAge}å²å‰
                                ${t.completed ? `<br>âœ“ å®Œæˆäº${t.completedAge}å²` : ''}
                            </p>
                        </div>
                        <div>
                            <span class="target-status">${t.completed ? 'ğŸ‰' : 'â³'}</span>
                            <button class="btn-small btn-danger" onclick="removeTarget(${t.id})" 
                                ${(isRunning && !isPaused) ? 'disabled' : ''}>åˆ é™¤</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        document.getElementById('speedRange').addEventListener('input', function() {
            currentSpeed = parseInt(this.value);
            document.getElementById('speedValue').textContent = (currentSpeed / 1000).toFixed(2) + 'ç§’';
        });
        
        function updateUIState(state) {
            const badge = document.getElementById('configStatus');
            const configSection = document.getElementById('configSection');
            const targetSection = document.getElementById('targetSection');
            const pausedNotice = document.getElementById('pausedNotice');
            const btnAddTarget = document.getElementById('btnAddTarget');
            const startAgeInput = document.getElementById('startAge');
            
            if (state === 'running') {
                badge.textContent = 'è¿è¡Œä¸­';
                badge.className = 'status-badge running';
                configSection.classList.remove('paused');
                targetSection.classList.remove('paused');
                pausedNotice.style.display = 'none';
                btnAddTarget.disabled = true;
                
                document.querySelectorAll('input').forEach(input => {
                    if (input.id === 'startAge') {
                        input.disabled = true;
                        input.classList.add('locked-field');
                    } else if (input.id !== 'speedRange') {
                        input.disabled = true;
                    }
                });
            } else if (state === 'paused') {
                badge.textContent = 'å·²æš‚åœ';
                badge.className = 'status-badge paused';
                configSection.classList.add('paused');
                targetSection.classList.add('paused');
                pausedNotice.style.display = 'block';
                btnAddTarget.disabled = false;
                
                document.querySelectorAll('input').forEach(input => {
                    if (input.id === 'startAge') {
                        input.disabled = true;
                        input.classList.add('locked-field');
                    } else {
                        input.disabled = false;
                    }
                });
            } else {
                badge.textContent = 'æœªå¼€å§‹';
                badge.className = 'status-badge stopped';
                configSection.classList.remove('paused');
                targetSection.classList.remove('paused');
                pausedNotice.style.display = 'none';
                btnAddTarget.disabled = false;
                
                document.querySelectorAll('input').forEach(input => {
                    input.disabled = false;
                    input.classList.remove('locked-field');
                });
            }
        }
        
        function updateButtons() {
            document.getElementById('btnStart').disabled = isRunning;
            document.getElementById('btnPause').disabled = !isRunning || isPaused;
            document.getElementById('btnResume').disabled = !isPaused;
            document.getElementById('btnReset').disabled = false;
        }
        
        function getConfigFromInputs() {
            return {
                startAge: parseInt(document.getElementById('startAge').value),
                deadlineAge: parseInt(document.getElementById('deadlineAge').value),
                dailyCost: parseInt(document.getElementById('dailyCost').value),
                workIncome: parseInt(document.getElementById('workIncome').value),
                gambleWinRate: parseInt(document.getElementById('gambleWinRate').value),
                gambleWinAmount: parseInt(document.getElementById('gambleWinAmount').value),
                gambleLossAmount: parseInt(document.getElementById('gambleLossAmount').value)
            };
        }
        
        async function startSimulation() {
            if (targets.length === 0) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªç›®æ ‡ï¼');
                return;
            }
            
            const config = getConfigFromInputs();
            
            if (config.deadlineAge <= config.startAge) {
                alert('æœ€å¤§å¹´é¾„å¿…é¡»å¤§äºåˆå§‹å¹´é¾„ï¼');
                return;
            }
            
            document.getElementById('simArea').classList.add('active');
            document.getElementById('dailyLog').innerHTML = '';
            document.getElementById('finalResult').innerHTML = '';
            
            try {
                const response = await fetch('//simulate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'start', 
                        config, 
                        targets,
                        speed: currentSpeed 
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    isRunning = true;
                    isPaused = false;
                    isWaitingForResume = false;
                    updateUIState('running');
                    updateButtons();
                    runNextDay();
                }
            } catch (error) {
                alert('è¿æ¥å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // å…³é”®ä¿®å¤ï¼šä½¿ç”¨é€’å½’è€Œä¸æ˜¯ setIntervalï¼Œç¡®ä¿ç²¾ç¡®æ§åˆ¶æ¯ä¸€å¤©
        async function runNextDay() {
            if (!isRunning || isPaused) return;
            
            try {
                const response = await fetch('//simulate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'step' })
                });
                const data = await response.json();
                
                if (data.paused) {
                    // åç«¯å·²æš‚åœï¼Œç­‰å¾…ç”¨æˆ·ç»§ç»­
                    isPaused = true;
                    isWaitingForResume = true;
                    updateUIState('paused');
                    updateButtons();
                    return;
                }
                
                if (data.success) {
                    if (data.finished) {
                        isRunning = false;
                        showFinalResult(data);
                        updateUIState('stopped');
                        updateButtons();
                        updateStats(data.state);
                    } else {
                        addLogEntry(data.log);
                        updateDisplay(data.state);
                        updateStats(data.state);
                        
                        // æ£€æŸ¥æ˜¯å¦éœ€è¦æš‚åœï¼ˆç”¨æˆ·ç‚¹å‡»äº†æš‚åœï¼‰
                        if (data.paused || isPaused) {
                            isPaused = true;
                            isWaitingForResume = true;
                            document.getElementById('pausedDay').textContent = data.log.day;
                            document.getElementById('nextDay').textContent = data.log.day + 1;
                            updateUIState('paused');
                            updateButtons();
                            
                            // æ·»åŠ æš‚åœæ ‡è®°åˆ°æ—¥å¿—
                            const logArea = document.getElementById('dailyLog');
                            const pauseDiv = document.createElement('div');
                            pauseDiv.className = 'log-entry paused-marker';
                            pauseDiv.innerHTML = `â¸ï¸ æ¨¡æ‹Ÿå·²æš‚åœ - ç¬¬${data.log.day}å¤©å·²å®Œæˆï¼Œç­‰å¾…ç»§ç»­...`;
                            logArea.appendChild(pauseDiv);
                            logArea.scrollTop = logArea.scrollHeight;
                            
                            return; // åœæ­¢ï¼Œä¸ç»§ç»­ä¸‹ä¸€å¤©
                        }
                        
                        // ç»§ç»­ä¸‹ä¸€å¤©
                        simulationTimeout = setTimeout(() => {
                            runNextDay();
                        }, currentSpeed);
                    }
                }
            } catch (error) {
                console.error('æ¨¡æ‹Ÿå‡ºé”™:', error);
                // å‡ºé”™åé‡è¯•
                simulationTimeout = setTimeout(() => {
                    runNextDay();
                }, 2000);
            }
        }
        
        async function requestPause() {
            // ç«‹å³æ›´æ–°UIï¼Œè®©ç”¨æˆ·çŸ¥é“å·²æ”¶åˆ°æš‚åœè¯·æ±‚
            document.getElementById('btnPause').textContent = 'â³ æš‚åœä¸­...';
            document.getElementById('btnPause').disabled = true;
            
            // è®¾ç½®å‰ç«¯æš‚åœæ ‡å¿—ï¼Œè®©å½“å‰è¿™å¤©å®Œæˆååœæ­¢
            isPaused = true;
            
            // é€šçŸ¥åç«¯
            try {
                await fetch('//simulate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'pause' })
                });
            } catch (error) {
                console.error('æš‚åœè¯·æ±‚å¤±è´¥:', error);
            }
            
            // æ³¨æ„ï¼šä¸ç«‹å³æ›´æ–°UIçŠ¶æ€ï¼Œç­‰å¾…å½“å‰å¤©å®Œæˆåå†æ›´æ–°
        }
        
        async function resumeSimulation() {
            if (targets.length === 0) {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªç›®æ ‡ï¼');
                return;
            }
            
            const config = getConfigFromInputs();
            
            isPaused = false;
            isWaitingForResume = false;
            updateUIState('running');
            updateButtons();
            
            // é‡ç½®æŒ‰é’®æ–‡å­—
            document.getElementById('btnPause').textContent = 'â¸ï¸ æš‚åœä¿®æ”¹';
            
            await fetch('//simulate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    action: 'resume', 
                    config,
                    targets
                })
            });
            
            // ç»§ç»­ä¸‹ä¸€å¤©
            runNextDay();
        }
        
        async function resetSimulation() {
            isRunning = false;
            isPaused = false;
            isWaitingForResume = false;
            if (simulationTimeout) clearTimeout(simulationTimeout);
            
            document.getElementById('simArea').classList.remove('active');
            document.getElementById('dailyLog').innerHTML = '';
            document.getElementById('finalResult').innerHTML = '';
            
            // é‡ç½®ç»Ÿè®¡
            document.getElementById('stat-work').textContent = '0å¤©';
            document.getElementById('stat-gamble').textContent = '0å¤©';
            document.getElementById('progress-work').style.width = '50%';
            document.getElementById('progress-gamble').style.width = '50%';
            document.getElementById('stat-money').textContent = '0';
            document.getElementById('stat-income').textContent = '0';
            document.getElementById('stat-expense').textContent = '0';
            document.getElementById('stat-wins').textContent = '0èƒœ';
            document.getElementById('stat-losses').textContent = '0è´Ÿ';
            document.getElementById('stat-winrate').textContent = '0%';
            document.getElementById('stat-days').textContent = '0';
            document.getElementById('stat-age').textContent = document.getElementById('startAge').value;
            
            // é‡ç½®æŒ‰é’®
            document.getElementById('btnPause').textContent = 'â¸ï¸ æš‚åœä¿®æ”¹';
            
            targets.forEach(t => { 
                t.completed = false; 
                delete t.completedAge; 
            });
            
            updateUIState('stopped');
            updateButtons();
            renderTargets();
            
            await fetch('//simulate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'reset' })
            });
        }
        
        function updateStats(state) {
            if (!state.stats) return;
            
            const stats = state.stats;
            const history = state.history;
            
            document.getElementById('stat-work').textContent = stats.workCount + 'å¤©';
            document.getElementById('stat-gamble').textContent = stats.gambleCount + 'å¤©';
            
            const total = stats.workCount + stats.gambleCount;
            if (total > 0) {
                const workPercent = (stats.workCount / total * 100).toFixed(1);
                const gamblePercent = (stats.gambleCount / total * 100).toFixed(1);
                document.getElementById('progress-work').style.width = workPercent + '%';
                document.getElementById('progress-work').textContent = `æ‰“å·¥ ${workPercent}%`;
                document.getElementById('progress-gamble').style.width = gamblePercent + '%';
                document.getElementById('progress-gamble').textContent = `èµŒåš ${gamblePercent}%`;
            }
            
            document.getElementById('stat-money').textContent = state.currentMoney.toLocaleString();
            document.getElementById('stat-income').textContent = stats.totalIncome.toLocaleString();
            document.getElementById('stat-expense').textContent = stats.totalExpenses.toLocaleString();
            document.getElementById('stat-wins').textContent = history.wins + 'èƒœ';
            document.getElementById('stat-losses').textContent = history.losses + 'è´Ÿ';
            
            const totalGambles = history.wins + history.losses;
            const winRate = totalGambles > 0 ? (history.wins / totalGambles * 100).toFixed(1) : 0;
            document.getElementById('stat-winrate').textContent = winRate + '%';
            
            document.getElementById('stat-days').textContent = stats.totalDays;
            document.getElementById('stat-age').textContent = state.currentAge;
        }
        
        function addLogEntry(log) {
            const logArea = document.getElementById('dailyLog');
            
            if (log.yearPassed) {
                const yearDiv = document.createElement('div');
                yearDiv.className = 'year-marker';
                yearDiv.textContent = `ğŸ“… ${log.age}å²ç”Ÿæ—¥ï¼`;
                logArea.appendChild(yearDiv);
            }
            
            if (log.completedTarget) {
                const targetDiv = document.createElement('div');
                targetDiv.className = 'target-completed-notice';
                targetDiv.innerHTML = `ğŸ‰ è¾¾æˆç›®æ ‡ï¼š${log.completedTarget.name}ï¼<br>ç´¯è®¡å­˜æ¬¾çªç ´ ${log.completedTarget.amount.toLocaleString()}å…ƒ`;
                logArea.appendChild(targetDiv);
                
                const target = targets.find(t => t.description === log.completedTarget.name);
                if (target) {
                    target.completed = true;
                    target.completedAge = log.age;
                    renderTargets();
                }
            }
            
            const div = document.createElement('div');
            let type = 'work';
            if (log.action.includes('èµ¢')) type = 'gamble-win';
            if (log.action.includes('è¾“')) type = 'gamble-loss';
            
            div.className = `log-entry ${type}`;
            div.innerHTML = `
                <div class="log-header">
                    <span class="log-action">
                        ç¬¬${log.day}å¤© (${log.age}å²${log.dayInYear}å¤©) ${log.action}
                    </span>
                    <span class="log-pressure" title="å‹åŠ›${log.pressure}ï¼š${log.pressureReason}">
                        ${log.pressureEmoji}
                    </span>
                </div>
                <div class="log-body">
                    ğŸ’° å‡€æ”¶å…¥: ${log.netIncome > 0 ? '+' : ''}${log.netIncome}å…ƒ | 
                    å­˜æ¬¾: ${log.totalMoney.toLocaleString()}å…ƒ | 
                    çŠ¶æ€: ${log.pressureText} (${log.pressure}/100)<br>
                    ${log.description}
                </div>
                <div class="log-reason">
                    ğŸ¤– AIå†³ç­–: ${log.decisionReason}
                </div>
            `;
            logArea.appendChild(div);
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        function updateDisplay(state) {
            document.getElementById('display-age').textContent = `${state.currentAge}å²`;
            document.getElementById('display-money').textContent = `${state.currentMoney.toLocaleString()}å…ƒ`;
            document.getElementById('display-day').textContent = `${state.dayCount}å¤©`;
            
            const activeTarget = state.targets.find(t => !t.completed);
            if (activeTarget) {
                document.getElementById('display-target').innerHTML = 
                    `${activeTarget.description}<br><small>éœ€ç´¯è®¡${activeTarget.accumulatedAmount.toLocaleString()}å…ƒ</small>`;
            } else {
                document.getElementById('display-target').textContent = 'å…¨éƒ¨å®Œæˆï¼';
            }
            
            if (state.pressure) {
                document.getElementById('display-pressure').textContent = 
                    `${state.pressure.emoji} ${state.pressure.text}`;
                document.getElementById('pressure-reason').textContent = state.pressure.reason;
            }
        }
        
        function showFinalResult(data) {
            const div = document.createElement('div');
            const completedCount = data.state.targets.filter(t => t.completed).length;
            div.className = `final-result ${data.reason === 'success' ? 'success' : 'fail'}`;
            div.innerHTML = `
                ${data.message}<br>
                <small style="font-size:14px; font-weight:normal;">
                    å†æ—¶${data.state.dayCount}å¤©ï¼Œæœ€ç»ˆå­˜æ¬¾${data.state.currentMoney.toLocaleString()}å…ƒ<br>
                    å®Œæˆç›®æ ‡: ${completedCount}/${data.state.targets.length}<br>
                    æ‰“å·¥${data.state.stats.workCount}å¤© vs èµŒåš${data.state.stats.gambleCount}å¤©
                </small>
            `;
            document.getElementById('finalResult').appendChild(div);
        }
    </script>
</body>
</html>